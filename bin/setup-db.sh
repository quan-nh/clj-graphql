#!/usr/bin/env bash

docker exec -i --user postgres clj-graphql_db_1 createdb test_db

docker exec -i --user postgres clj-graphql_db_1 psql test_db -a  <<__END
create user test_user password 'pwd';
__END

docker exec -i clj-graphql_db_1 psql -Utest_user test_db -a <<__END
drop table if exists game_rating;
drop table if exists member;
drop table if exists board_game;

CREATE OR REPLACE FUNCTION maintain_updated_at()
RETURNS TRIGGER AS \$\$
BEGIN
   NEW.updated_at = now();
   RETURN NEW;
END;
\$\$ language 'plpgsql';

create table member (
  id int generated by default as identity primary key,
  name text not null,
  created_at timestamp not null default current_timestamp,
  updated_at timestamp not null default current_timestamp);

create trigger member_updated_at before update
on member for each row execute procedure
maintain_updated_at();

create table board_game (
  id int generated by default as identity primary key,
  name text not null,
  description text,
  designers text,
  min_players integer,
  max_players integer,
  created_at timestamp not null default current_timestamp,
  updated_at timestamp not null default current_timestamp);

create trigger board_game_updated_at before update
on board_game for each row execute procedure
maintain_updated_at();

create table game_rating (
  game_id int references board_game(id),
  member_id int references member(id),
  rating integer not null,
  created_at timestamp not null default current_timestamp,
  updated_at timestamp not null default current_timestamp);

alter table game_rating add constraint cost_unique__game_rating_game_id_member_id
unique (game_id, member_id);

create trigger game_rating_updated_at before update
on game_rating for each row execute procedure
maintain_updated_at();

insert into board_game (id, name, description, designers, min_players, max_players) values
  (1234, 'Zertz', 'Two player abstract with forced moves and shrinking board', 'Kris Burm', 2, 2),
  (1235, 'Dominion', 'Created the deck-building genre; zillions of expansions', 'Donald X. Vaccarino', 2, null),
  (1236, 'Tiny Epic Galaxies', 'Fast dice-based sci-fi space game with a bit of chaos', 'Scott Almes', 1, 4),
  (1237, '7 Wonders: Duel', 'Tense, quick card game of developing civilizations', 'Antoine Bauza, Bruno Cathala', 2, 2);

alter table board_game alter column id restart with 1300;

insert into member (id, name) values
  (37, 'curiousattemptbunny'),
  (1410, 'bleedingedge'),
  (2812, 'missyo');

alter table member alter column id restart with 2900;

insert into game_rating (game_id, member_id, rating) values
  (1234, 37, 3),
  (1234, 1410, 5),
  (1236, 1410, 4),
  (1237, 1410, 4),
  (1237, 2812, 4),
  (1237, 37, 5);
__END
